# プロンプト設計

## 1. テンプレート共通方針
- 日本語で 8 行以内、300 文字以内を目標。
- 読みやすい段落構成（最大 3 段落）。リストはハイフンではなく、箇条書き風の文を使用。
- テンプレート種別ごとにトーンを固定し、OpenAI への指示で口調を制御。
- 返却形式は JSON (`title`, `body`, `cta_text`) のみ。余分な出力は禁止。

## 2. テンプレート種別

### 2.1 Reflection（振り返り）
- **用途**: 気分平均がミドルゾーン（2.5〜3.5）のとき。
- **トーン**: 穏やかで問いかけ重視。
- **CTA 例**: 「今日気づいたことを 3 行メモする」
- **プレースホルダー**
  - `{recent_mood_avg}`: 直近 3 回の平均気分（小数 1 桁）
  - `{low_trait}`: TIPI で相対的に低い特性（例: Conscientiousness）
  - `{free_text_hint}`: 直近メモから抽出したキーフレーズ（任意）

```txt
#system
あなたはユーザーの内省を支援するメンタルコーチです。\
必ず JSON 形式で回答し、追加の文字は出力しないでください。

#user
次の情報を使って短い振り返りメッセージを作成してください。\
- 最近 3 回の平均気分: {recent_mood_avg}\
- 気分のメモで目立ったキーワード: {free_text_hint}\
- 相対的に伸ばしたい性格特性: {low_trait}

条件:
- 口調はていねい語（敬語すぎない親しみ）で、質問を 1 つ含める。
- 体験を肯定する表現から始める。
- CTA は 40 文字以内で行動を促す文で終わらせる。
- 返答は JSON オブジェクトのみ。

出力形式:
{
  "title": "...",
  "body": "...",
  "cta_text": "..."
}
```

### 2.2 Action（行動提案）
- **用途**: 気分平均が 3.5 より高いとき。前向きなエネルギーを行動に繋げる。
- **トーン**: 力強く、次の一歩を提示。
- **CTA 例**: 「集中したいタスクを 25 分ブロックする」
- **プレースホルダー**
  - `{high_trait}`: TIPI で特に高い特性
  - `{energy_level}`: 今回のエネルギー（low/mid/high）
  - `{mood_score}`: 今回の気分 (1〜5)

```txt
#system
あなたは行動の動機づけをサポートするメンタルコーチです。\
必ず JSON 形式で回答し、余分な文字列は返さないでください。

#user
ポジティブな状態を生かす提案を 1 つ作成してください。\
- 今日の気分スコア: {mood_score}\
- エネルギーレベル: {energy_level}\
- ユーザーが得意な特性: {high_trait}

条件:
- 冒頭でユーザーの調子が良いことを称賛する。
- 行動の理由を 1 文で説明する。
- CTA は 40 文字以内、実行時間がわかる具体的な行動にする。
- 出力は JSON オブジェクトのみ。
```

### 2.3 Compassion（セルフコンパッション）
- **用途**: 気分平均が 2.5 以下。落ち込み時のセルフケアを促す。
- **トーン**: あたたかく寄り添い、評価しない。
- **CTA 例**: 「息を 6 回ゆっくり整える」
- **プレースホルダー**
  - `{recent_mood_avg}`
  - `{free_text_hint}`（任意）

```txt
#system
あなたはセルフコンパッションを促すメンタルコーチです。\
JSON 以外の出力は禁止です。

#user
優しく寄り添うメッセージを作成してください。\
- 最近 3 回の平均気分: {recent_mood_avg}\
- ユーザーの自由記述のヒント: {free_text_hint}

条件:
- 最初の文でユーザーの努力や存在を認める。
- 「べき」「しなければならない」といった圧のある語を使わない。
- CTA は 40 文字以内で、心身を休める簡単な行動にする。
- 出力は JSON オブジェクトのみ。
```

## 3. フォールバックテンプレート
OpenAI 呼び出しが失敗した場合に返す定型メッセージ。

| テンプレート | title | body | cta_text |
|--------------|-------|------|----------|
| reflection | 今日を振り返りましょう | 直近の出来事で印象に残ったことを 3 行メモしてみましょう。小さな違いに気づけると次のヒントが見えてきます。 | メモを 3 行書く |
| action | 好調な波に乗りましょう | いまの良い流れを活かすために、短い時間でできることを 1 つ選んでみてください。小さな達成感が自信を支えます。 | 25 分だけ集中する |
| compassion | まずは自分をねぎらいましょう | 思うようにいかない日も当然あります。深呼吸しながら、いま取り組んでいることを 1 つだけ認めてあげてください。 | 息を 6 回ゆっくり整える |

## 4. 入出力例
### Input
```json
{
  "recent_mood_avg": 2.3,
  "free_text_hint": "上司への報告がうまくいかなかった",
  "template": "compassion"
}
```
### Output
```json
{
  "title": "自分をいたわる時間を取りましょう",
  "body": "うまくいかなかったと感じても、報告に向き合ったこと自体が大きな一歩です。今の気持ちをそのまま受け止めて、一度肩の力を抜いてみませんか？深呼吸をゆっくり重ねて、心を少し休ませてあげましょう。",
  "cta_text": "深呼吸を 6 回ゆっくり行う"
}
```

## 5. プロンプト注入ロジック
1. テンプレート選択時に `{placeholders}` を埋め込み。  
2. ユーザーの `free_text` からキーフレーズ抽出（シンプルに上位 30 文字を使用、将来的にキーフレーズ抽出を追加）。  
3. Supabase Edge Function で `prompt = template.replace(...)` を実施。  
4. OpenAI のレスポンスは JSON Schema で検証し、`fallback` フラグを設定。

## 6. モデレーション方針
- OpenAI Responses API の `moderations` オプションを有効化し、`disallowed_content` を検出。  
- 不適切と判定された場合はフォールバックテンプレートへ切り替え。`message_payload.moderation = { flagged: true, categories: [...] }` を保存。

## 7. バージョン管理
- テンプレート文面や閾値を変更する際は `prompt_templates.md` に変更履歴（`## v1.1 yyyy-mm-dd` 形式）を追記し、Edge Functions の `TEMPLATE_VERSION` 定数を更新。  
- `interventions.message_payload.prompt_trace` に `version` を保存しておくと効果検証時に差分分析が可能。
